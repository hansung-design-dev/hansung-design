# 기간 표시 및 신청 로직 설명

## 📋 전체 흐름 개요

1. **백엔드**: 매월 1일 자동으로 2개월 뒤 기간 데이터 생성
2. **프론트엔드**: 현재 날짜에 따라 표시할 기간 탭 결정
3. **신청 가능 여부**: 기간 시작일 2일 전까지 신청 가능

---

## 1️⃣ 백엔드 기간 생성 (`/api/schedule-period-generation`)

### 실행 시점

- **자동**: 매월 1일 00:05 KST (Vercel Cron)
- **수동**: `force=true` 파라미터로 언제든 실행 가능

### 생성 대상

- **2개월 뒤**의 기간 데이터 생성
- 예: 12월 1일 실행 → **2월** 상하반기 데이터 생성

### 생성 데이터

각 구(region_gu)별로 상하반기 2개씩 생성:

**일반 구** (대부분):

- 상반기: `YYYY-MM-01` ~ `YYYY-MM-15`
- 하반기: `YYYY-MM-16` ~ `YYYY-MM-31` (또는 해당 월 마지막 날)

**특수 구** (마포구, 강북구):

- 상반기: `YYYY-MM-05` ~ `YYYY-MM-19`
- 하반기: `YYYY-MM-20` ~ `YYYY+1-MM+1-04` (다음 달 4일까지)

### 데이터베이스 저장

- 테이블: `region_gu_display_periods`
- 컬럼: `year_month`, `period`, `period_from`, `period_to` 등

---

## 2️⃣ 프론트엔드 탭 표시 로직 (`HalfPeriodTabs.tsx`)

### 현재 날짜에 따른 탭 표시 규칙

#### 일반 구 (마포구/강북구 제외)

**1일~15일**:

- 첫 번째 탭: **현재 달 하반기** (예: 12월 1일 → 12월 하반기)
- 두 번째 탭: **다음 달 상반기** (예: 12월 1일 → 1월 상반기)

**16일~31일**:

- 첫 번째 탭: **다음 달 상반기** (예: 12월 16일 → 1월 상반기)
- 두 번째 탭: **다음 달 하반기** (예: 12월 16일 → 1월 하반기)

#### 특수 구 (마포구, 강북구)

**1일~4일**:

- 첫 번째 탭: **현재 달 하반기** (20일~다음달 4일)
- 두 번째 탭: **다음 달 상반기** (5일~19일)

**5일~31일**:

- 첫 번째 탭: **다음 달 상반기** (5일~19일)
- 두 번째 탭: **다음 달 하반기** (20일~다다음달 4일)

### 예시 시나리오

**11월 30일**:

- 표시: 12월 상반기, 12월 하반기
- 12월 상반기: 신청 불가 (시작일 2일 전)
- 12월 하반기: 신청 가능

**12월 1일**:

- 표시: 12월 하반기, 1월 상반기
- 12월 하반기: 신청 가능
- 1월 상반기: 신청 가능

**12월 16일**:

- 표시: 1월 상반기, 1월 하반기
- 1월 상반기: 신청 가능
- 1월 하반기: 신청 가능

---

## 3️⃣ 신청 가능 여부 판단 (`isPeriodAvailable`)

### 로직

```typescript
daysUntilPeriod = (기간 시작일 - 오늘 날짜) 일수
isAvailable = daysUntilPeriod > 2
```

### 규칙

- **기간 시작일 2일 전까지**: 신청 가능 ✅ (daysUntilPeriod > 2)
- **기간 시작일 2일 전부터**: 신청 불가 ❌ (daysUntilPeriod <= 2)

### 예시

- **12월 상반기** 시작일: 12월 1일

  - 11월 28일까지: 신청 가능 ✅ (3일 이상 남음)
  - 11월 29일부터: 신청 불가 ❌ (2일 이하 남음)

- **12월 하반기** 시작일: 12월 16일
  - 12월 13일까지: 신청 가능 ✅ (3일 이상 남음)
  - 12월 14일부터: 신청 불가 ❌ (2일 이하 남음)

---

## 4️⃣ 상세 페이지 로직 (`displayDetailPage.tsx`)

### 선택된 기간 계산

- `selectedPeriodYear`, `selectedPeriodMonth`, `selectedHalfPeriod`를 기반으로
- `getSelectedPeriodStartDate()` 함수로 실제 시작일 계산

### 리스트 표시/숨김

- `isSelectedPeriodClosed = true`인 경우:
  - 리스트 숨김
  - "해당 분기는 신청마감되었습니다" 메시지 표시

### 아이템 선택 가능 여부 (`isItemSelectable`)

1. **기간 유효성**: `isPeriodAvailable()` 체크
2. **재고 확인**: 선택된 상하반기의 `closure_quantity` < `faces`

---

## 🔄 전체 흐름도

```
[백엔드] 매월 1일 00:05 KST
    ↓
[DB] 2개월 뒤 기간 데이터 생성/저장
    ↓
[프론트] 사용자 접속
    ↓
[프론트] 현재 날짜 기준으로 표시할 탭 결정
    ↓
[프론트] 각 탭의 신청 가능 여부 계산 (시작일 2일 전까지)
    ↓
[프론트] 사용자가 탭 선택
    ↓
[프론트] 선택된 기간이 마감되었는지 확인
    ↓
[프론트] 마감 안 됨 → 리스트 표시, 마감됨 → 메시지 표시
    ↓
[프론트] 아이템 선택 시 기간 유효성 + 재고 확인
```

---

## ⚠️ 주의사항

1. **타임존**: 모든 날짜 계산은 **KST (UTC+9)** 기준
2. **백엔드 생성 시점**: 2개월 뒤 데이터를 생성하므로, 실제 사용 시점에는 이미 데이터가 있어야 함
3. **탭 표시 로직**: 현재 날짜의 일(day)에 따라 표시되는 탭이 달라짐
4. **신청 마감**: 기간 시작일 2일 전부터는 신청 불가 (하지만 탭은 계속 표시됨)

---

## 🐛 디버깅 팁

1. **콘솔 로그 확인**:

   - `🔍 Calculating periods based on current date`
   - `🔍 isPeriodAvailable Debug`
   - `🔍 HalfPeriodTabs Debug`

2. **API 확인**:

   - `/api/check-periods?year_month=2026-01`: 특정 월의 기간 데이터 확인

3. **수동 기간 생성**:
   ```bash
   curl -X POST "http://localhost:3000/api/schedule-period-generation?force=true" \
     -H "x-cron-secret: YOUR_SECRET" \
     -d '{"targetYear": 2026, "targetMonth": 1}'
   ```
