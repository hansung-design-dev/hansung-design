import { NextRequest, NextResponse } from 'next/server';
import { supabase } from '@/src/lib/supabase';

// ÌòÑÏàòÎßâ Í≤åÏãúÎåÄ ÌÉÄÏûÖ Ï†ïÏùò
export interface BannerDisplayData {
  id: string;
  panel_code: number;
  nickname: string | null;
  address: string;
  panel_status: string;
  panel_type: string;
  max_banner: number; // panelsÏóêÏÑú Í∞ÄÏ†∏Ïò§Îäî max_banner
  photo_url?: string; // ÏÇ¨ÏßÑ URL Ï∂îÍ∞Ä
  latitude?: number; // ÏúÑÎèÑ Ï∂îÍ∞Ä
  longitude?: number; // Í≤ΩÎèÑ Ï∂îÍ∞Ä
  region_gu: {
    id: string;
    name: string;
    code: string;
  };
  region_dong: {
    id: string;
    name: string;
  };
  banner_panel_details: {
    id: string;
    is_for_admin: boolean;
  };
  banner_slots: {
    id: string;
    slot_number: number;
    slot_name: string;
    max_width: number;
    max_height: number;
    banner_type: string;
    price_unit: string;
    panel_slot_status: string;
    // banner_slot_price_policy Ï†ïÎ≥¥Î°ú Í∞ÄÍ≤© Ï†ïÎ≥¥ ÎåÄÏ≤¥
    price_policies: {
      id: string;
      price_usage_type: 'default' | 'public_institution' | 'company';
      tax_price: number;
      road_usage_fee: number;
      advertising_fee: number;
      total_price: number;
    }[];
    // Ïä¨Î°ØÎ≥Ñ Í∞úÎ≥Ñ Ïû¨Í≥† Ï†ïÎ≥¥ Ï∂îÍ∞Ä
    slot_inventory?: {
      is_available: boolean;
      is_closed: boolean;
      period?: string;
      year_month?: string;
    }[];
  }[];
  // Í∏∞Ï°¥ Ìå®ÎÑê Î†àÎ≤® Ïû¨Í≥† Ï†ïÎ≥¥ (ÌïòÏúÑ Ìò∏ÌôòÏÑ± Ïú†ÏßÄ)
  banner_slot_inventory?: BannerSlotInventory[];
  inventory_data?: {
    current_period: {
      total_slots: number;
      available_slots: number;
      closed_slots: number;
      period: string | undefined;
      year_month: string | undefined;
    } | null;
    first_half: {
      total_slots: number;
      available_slots: number;
      closed_slots: number;
    } | null;
    second_half: {
      total_slots: number;
      available_slots: number;
      closed_slots: number;
    } | null;
  };
}

// Ï∂îÍ∞Ä ÌÉÄÏûÖ Ï†ïÏùòÎì§
interface RegionGuDisplayPeriod {
  id: string;
  year_month: string;
  period: string;
  period_from: string;
  period_to: string;
}

interface BannerSlotInventory {
  id: string;
  total_slots: number;
  available_slots: number;
  closed_slots: number;
  region_gu_display_periods?: RegionGuDisplayPeriod;
}

interface PanelWithSlots {
  id: string;
  panel_type: string;
  banner_slots: {
    slot_number: number;
    banner_slot_price_policy: {
      id: string;
      price_usage_type: string;
      tax_price: number;
      road_usage_fee: number;
      advertising_fee: number;
      total_price: number;
    }[];
  }[];
}

interface BankData {
  id: string;
  bank_name: string;
  account_number: string;
  depositor: string;
  region_gu: {
    id: string;
    name: string;
  };
  display_types: {
    id: string;
    name: string;
  };
}

interface ProcessedDistrictData {
  id: string;
  name: string;
  code: string;
  logo_image_url: string | null;
  phone_number?: string;
  display_type_id: string;
  panel_status: string;
  period: {
    first_half_from: string;
    first_half_to: string;
    second_half_from: string | null;
    second_half_to: string | null;
  } | null;
  bank_accounts: BankData | null;
  pricePolicies: {
    id: string;
    price_usage_type: string;
    tax_price: number;
    road_usage_fee: number;
    advertising_fee: number;
    total_price: number;
    displayName?: string;
  }[];
}

// ÌòÑÏàòÎßâ Í≤åÏãúÎåÄ ÌÉÄÏûÖ ID Ï°∞Ìöå
async function getBannerDisplayTypeId() {
  try {
    const { data, error } = await supabase
      .from('display_types')
      .select('id')
      .eq('name', 'banner_display')
      .single();

    if (error) {
      throw error;
    }

    if (!data) {
      throw new Error('Banner display type not found');
    }

    return data;
  } catch (error) {
    throw error;
  }
}

// ÌäπÏ†ï Íµ¨Ïùò ÌòÑÏàòÎßâ Í≤åÏãúÎåÄ Îç∞Ïù¥ÌÑ∞ Ï°∞Ìöå
async function getBannerDisplaysByDistrict(districtName: string) {
  try {
    // ÎèôÏ†ÅÏúºÎ°ú ÌòÑÏû¨ ÎÇ†Ïßú Í∏∞Ï§ÄÏúºÎ°ú ÎåÄÏÉÅ Ïõî Í≥ÑÏÇ∞
    const now = new Date();
    const koreaTime = new Date(now.getTime() + 9 * 60 * 60 * 1000);
    const currentYear = koreaTime.getFullYear();
    const currentMonth = koreaTime.getMonth() + 1;
    const currentDay = koreaTime.getDate();

    // ÌòÑÏû¨ ÎÇ†ÏßúÏóê Îî∞Îùº Ïã†Ï≤≠ Í∞ÄÎä•Ìïú Í∏∞Í∞Ñ Í≥ÑÏÇ∞
    let targetYear = currentYear;
    let targetMonth = currentMonth;

    if (currentDay >= 13) {
      if (currentMonth === 12) {
        targetYear = currentYear + 1;
        targetMonth = 1;
      } else {
        targetMonth = currentMonth + 1;
      }
    }

    const targetYearMonth = `${targetYear}ÎÖÑ ${targetMonth}Ïõî`;
    console.log('üîç Target year/month for district:', targetYearMonth);

    // Î®ºÏ†Ä Ìï¥Îãπ Íµ¨Ïùò region_gu_idÎ•º Ï∞æÍ∏∞
    const { data: regionData, error: regionError } = await supabase
      .from('region_gu')
      .select('id')
      .eq('name', districtName)
      .eq('display_type_id', (await getBannerDisplayTypeId()).id)
      .eq('is_active', 'true')
      .single();

    if (regionError || !regionData) {
      throw new Error(`Íµ¨Î•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§: ${districtName}`);
    }

    const query = supabase
      .from('panels')
      .select(
        `
        *,
        banner_panel_details (
          id,
          is_for_admin
        ),
        banner_slots (
          id,
          slot_number,
          slot_name,
          max_width,
          max_height,
          banner_type,
          price_unit,
          panel_slot_status,
          banner_slot_price_policy!banner_slot_price_policy_banner_slot_id_fkey (
            id,
            price_usage_type,
            tax_price,
            road_usage_fee,
            advertising_fee,
            total_price
          )
        ),
        region_gu!inner (
          id,
          name,
          code
        ),
        region_dong!inner (
          id,
          name
        )
      `
      )
      .eq('region_gu_id', regionData.id)
      .eq('display_type_id', (await getBannerDisplayTypeId()).id)
      .eq('panel_status', 'active');

    const { data, error } = await query.order('panel_code', {
      ascending: true,
    });

    if (error) {
      throw error;
    }

    // Ïä¨Î°ØÎ≥Ñ Í∞úÎ≥Ñ Ïû¨Í≥† Ï†ïÎ≥¥ Ï°∞Ìöå (banner_slotsÏôÄ ÏßÅÏ†ë Ïó∞Í≤∞)
    let slotInventoryData = null;
    let slotInventoryError = null;

    if (data && data.length > 0) {
      // banner_slot_id Î™©Î°ù Ï∂îÏ∂ú
      const bannerSlotIds = data.flatMap(
        (item) =>
          item.banner_slots?.map((slot: { id: string }) => slot.id) || []
      );

      if (bannerSlotIds.length > 0) {
        const slotInventoryQuery = supabase
          .from('banner_slot_inventory')
          .select(
            `
            banner_slot_id,
            is_available,
            is_closed,
            region_gu_display_periods (
              id,
              year_month,
              period,
              period_from,
              period_to
            )
          `
          )
          .in('banner_slot_id', bannerSlotIds)
          .eq('region_gu_display_periods.year_month', targetYearMonth);

        const result = await slotInventoryQuery;
        slotInventoryData = result.data;
        slotInventoryError = result.error;
      }
    }

    if (slotInventoryError) {
      console.error('Ïä¨Î°ØÎ≥Ñ Ïû¨Í≥† Ï°∞Ìöå Ïò§Î•ò:', slotInventoryError);
    }

    // Ïä¨Î°ØÎ≥Ñ Ïû¨Í≥† Ï†ïÎ≥¥Î•º banner_slot_idÎ≥ÑÎ°ú Í∑∏Î£πÌôî
    const slotInventoryByBannerSlot =
      slotInventoryData?.reduce(
        (acc, item) => {
          acc[item.banner_slot_id] = {
            is_available: item.is_available,
            is_closed: item.is_closed,
            period: item.region_gu_display_periods?.[0]?.period,
            year_month: item.region_gu_display_periods?.[0]?.year_month,
          };
          return acc;
        },
        {} as Record<
          string,
          {
            is_available: boolean;
            is_closed: boolean;
            period?: string;
            year_month?: string;
          }
        >
      ) || {};

    const dataWithInventory = data?.map((item: BannerDisplayData) => {
      // Ïä¨Î°ØÎ≥Ñ Í∞úÎ≥Ñ Ïû¨Í≥† Ï†ïÎ≥¥ Ï∂îÍ∞Ä
      return {
        ...item,
        banner_slots: item.banner_slots?.map((slot) => ({
          ...slot,
          slot_inventory: slotInventoryByBannerSlot[slot.id]
            ? [slotInventoryByBannerSlot[slot.id]]
            : [],
        })),
        inventory_data: {
          current_period: null,
          first_half: null,
          second_half: null,
        },
      };
    });

    // Í∞ÄÍ≤©Ï†ïÏ±Ö Îç∞Ïù¥ÌÑ∞ Í≤ÄÏ¶ù Î∞è Î°úÍπÖ
    console.log('üîç Ï°∞Ìöå Í≤∞Í≥º:', {
      district: districtName,
      totalCount: dataWithInventory?.length || 0,
      targetYearMonth,
      panelTypes:
        dataWithInventory?.map((item: BannerDisplayData) => ({
          panel_code: item.panel_code,
          panel_type: item.panel_type,
          nickname: item.nickname,
          banner_slot_info_count: item.banner_slots?.length || 0,
          price_policies_count:
            item.banner_slots?.reduce(
              (sum, slot) => sum + (slot.price_policies?.length || 0),
              0
            ) || 0,
          inventory_data: item.inventory_data,
          slot_inventory_count:
            item.banner_slots?.reduce(
              (sum, slot) => sum + (slot.slot_inventory?.length || 0),
              0
            ) || 0,
        })) || [],
    });

    // Í∞ÄÍ≤©Ï†ïÏ±Ö Îç∞Ïù¥ÌÑ∞ ÏÉÅÏÑ∏ Î°úÍπÖ
    dataWithInventory?.forEach((item: BannerDisplayData) => {
      item.banner_slots?.forEach((slot) => {
        if (slot.price_policies && slot.price_policies.length > 0) {
          console.log(
            `üîç ${districtName} - Panel ${item.panel_code} Slot ${slot.slot_number} Í∞ÄÍ≤©Ï†ïÏ±Ö:`,
            {
              panel_code: item.panel_code,
              slot_number: slot.slot_number,
              price_policies: slot.price_policies.map(
                (policy: {
                  price_usage_type: string;
                  total_price: number;
                  tax_price: number;
                  road_usage_fee: number;
                  advertising_fee: number;
                }) => ({
                  price_usage_type: policy.price_usage_type,
                  total_price: policy.total_price,
                  tax_price: policy.tax_price,
                  road_usage_fee: policy.road_usage_fee,
                  advertising_fee: policy.advertising_fee,
                })
              ),
            }
          );
        }
      });
    });

    return NextResponse.json({
      success: true,
      data: dataWithInventory as BannerDisplayData[],
    });
  } catch (error) {
    throw error;
  }
}

// Î™®Îì† Íµ¨Ïùò ÌòÑÏàòÎßâ Í≤åÏãúÎåÄ Îç∞Ïù¥ÌÑ∞ Ï°∞Ìöå
async function getAllBannerDisplays() {
  try {
    // display_type_id Í∞ÄÏ†∏Ïò§Í∏∞
    const displayType = await getBannerDisplayTypeId();

    const { data, error } = await supabase
      .from('panels')
      .select(
        `
        *,
        banner_panel_details (
          id,
          is_for_admin
        ),
        banner_slots (
          id,
          slot_number,
          slot_name,
          max_width,
          max_height,
          banner_type,
          price_unit,
          panel_slot_status,
          banner_slot_price_policy!banner_slot_price_policy_banner_slot_id_fkey (
            id,
            price_usage_type,
            tax_price,
            road_usage_fee,
            advertising_fee,
            total_price
          )
        ),
        region_gu!inner (
          id,
          name,
          code
        ),
        region_dong!inner (
          id,
          name
        )
      `
      )
      .eq('display_type_id', displayType.id)
      .eq('panel_status', 'active')
      .order('panel_code', { ascending: true });

    if (error) {
      throw error;
    }

    return NextResponse.json({
      success: true,
      data: data as BannerDisplayData[],
    });
  } catch (error) {
    throw error;
  }
}

// Íµ¨Î≥Ñ ÌòÑÏàòÎßâ Í≤åÏãúÎåÄ Í∞úÏàò Ï°∞Ìöå (ÏÉàÎ°úÏö¥ region_gu_display_types ÌÖåÏù¥Î∏î ÌôúÏö©)
async function getBannerDisplayCountsByDistrict() {
  try {
    const { data, error } = await supabase
      .from('active_region_gu_display_types')
      .select('region_name, region_code')
      .eq('display_type_name', 'banner_display');

    if (error) {
      throw error;
    }

    // Íµ¨Î≥Ñ Í∞úÏàò ÏßëÍ≥Ñ (panels ÌÖåÏù¥Î∏îÏóêÏÑú Ïã§Ï†ú Í∞úÏàò Í∞ÄÏ†∏Ïò§Í∏∞)
    const counts: Record<string, number> = {};

    for (const region of data || []) {
      const { count } = await supabase
        .from('panels')
        .select('*', { count: 'exact', head: true })
        .eq('region_gu.name', region.region_name)
        .eq('display_type_id', (await getBannerDisplayTypeId()).id)
        .eq('panel_status', 'active');

      counts[region.region_name] = count || 0;
    }

    return NextResponse.json({ success: true, data: counts });
  } catch (error) {
    throw error;
  }
}

// Í∞ÄÍ≤©Ï†ïÏ±Ö Îç∞Ïù¥ÌÑ∞ Ï°∞Ìöå API Ï∂îÍ∞Ä
async function getBannerDisplayPricePolicies() {
  try {
    console.log('üîç Fetching banner display price policies...');

    // Î™®Îì† Íµ¨Ïùò Í∞ÄÍ≤©Ï†ïÏ±Ö Îç∞Ïù¥ÌÑ∞ Ï°∞Ìöå
    const { data: pricePolicyData, error: priceError } = await supabase
      .from('banner_slot_price_policy')
      .select(
        `
        id,
        price_usage_type,
        tax_price,
        road_usage_fee,
        advertising_fee,
        total_price,
        banner_slots!inner (
          slot_number,
          panels!inner (
            region_gu_id,
            panel_type,
            display_type_id,
            region_gu!inner (
              id,
              name,
              code
            )
          )
        )
      `
      )
      .eq(
        'banner_slots.panels.display_type_id',
        '8178084e-1f13-40bc-8b90-7b8ddc58bf64'
      )
      .eq('banner_slots.slot_number', 1)
      .order('banner_slots.panels.region_gu.name', { ascending: true })
      .order('price_usage_type', { ascending: true });

    if (priceError) {
      console.error('‚ùå Í∞ÄÍ≤©Ï†ïÏ±Ö Ï°∞Ìöå Ïò§Î•ò:', priceError);
      throw priceError;
    }

    console.log('üîç Í∞ÄÍ≤©Ï†ïÏ±Ö Îç∞Ïù¥ÌÑ∞:', pricePolicyData?.length || 0);

    // Íµ¨Î≥ÑÎ°ú Í∞ÄÍ≤©Ï†ïÏ±Ö Í∑∏Î£πÌôî
    const districtPricePolicies: Record<
      string,
      {
        id: string;
        name: string;
        code: string;
        pricePolicies: {
          id: string;
          price_usage_type: string;
          tax_price: number;
          road_usage_fee: number;
          advertising_fee: number;
          total_price: number;
        }[];
      }
    > = {};

    if (pricePolicyData) {
      for (const policy of pricePolicyData) {
        // banner_slotsÎäî Î∞∞Ïó¥Ïù¥ÎØÄÎ°ú Ï≤´ Î≤àÏß∏ ÏöîÏÜå ÏÇ¨Ïö©
        const bannerSlot = Array.isArray(policy.banner_slots)
          ? policy.banner_slots[0]
          : policy.banner_slots;
        const panel = Array.isArray(bannerSlot?.panels)
          ? bannerSlot.panels[0]
          : bannerSlot?.panels;
        const regionGu = Array.isArray(panel?.region_gu)
          ? panel.region_gu[0]
          : panel?.region_gu;

        const districtName = regionGu?.name;
        const districtCode = regionGu?.code;
        const districtId = regionGu?.id;

        if (!districtPricePolicies[districtName]) {
          districtPricePolicies[districtName] = {
            id: districtId,
            name: districtName,
            code: districtCode,
            pricePolicies: [],
          };
        }

        // Ï§ëÎ≥µ Ï†úÍ±∞ (Í∞ôÏùÄ price_usage_typeÏùÄ ÌïòÎÇòÎßå)
        const existingPolicy = districtPricePolicies[
          districtName
        ].pricePolicies.find(
          (p) => p.price_usage_type === policy.price_usage_type
        );

        if (!existingPolicy) {
          districtPricePolicies[districtName].pricePolicies.push({
            id: policy.id,
            price_usage_type: policy.price_usage_type,
            tax_price: policy.tax_price,
            road_usage_fee: policy.road_usage_fee,
            advertising_fee: policy.advertising_fee,
            total_price: policy.total_price,
          });
        }
      }
    }

    // Íµ¨Î≥Ñ ÏàúÏÑú Ï†ïÎ†¨
    const orderMap: Record<string, number> = {
      Í¥ÄÏïÖÍµ¨: 1,
      ÎßàÌè¨Íµ¨: 2,
      ÏÑúÎåÄÎ¨∏Íµ¨: 3,
      ÏÜ°ÌååÍµ¨: 4,
      Ïö©ÏÇ∞Íµ¨: 5,
      Í∞ïÎ∂ÅÍµ¨: 6,
    };

    const sortedDistricts = Object.values(districtPricePolicies).sort(
      (a, b) => {
        const orderA = orderMap[a.name] || 999;
        const orderB = orderMap[b.name] || 999;
        return orderA - orderB;
      }
    );

    console.log(
      'üîç Íµ¨Î≥Ñ Í∞ÄÍ≤©Ï†ïÏ±Ö:',
      sortedDistricts.map((d) => ({
        name: d.name,
        policyCount: d.pricePolicies.length,
        policies: d.pricePolicies.map((p) => ({
          type: p.price_usage_type,
          total_price: p.total_price,
        })),
      }))
    );

    return NextResponse.json({
      success: true,
      data: sortedDistricts,
    });
  } catch (error) {
    console.error('‚ùå Error in getBannerDisplayPricePolicies:', error);
    throw error;
  }
}

// GET ÏöîÏ≤≠ Ï≤òÎ¶¨
export async function GET(request: NextRequest) {
  const { searchParams } = new URL(request.url);
  const action = searchParams.get('action');
  const district = searchParams.get('district');

  console.log('üîç Banner Display API called with action:', action);

  try {
    switch (action) {
      case 'getAllDistrictsData':
        return await getAllDistrictsData();
      case 'getOptimizedDistrictsData':
        return await getOptimizedDistrictsData();
      case 'getCounts':
        return await getBannerDisplayCountsByDistrict();
      case 'getByDistrict':
        return await getBannerDisplaysByDistrict(district!);
      case 'getAll':
        return await getAllBannerDisplays();
      case 'getPricePolicies':
        return await getBannerDisplayPricePolicies();
      default:
        return NextResponse.json(
          { success: false, error: 'Invalid action' },
          { status: 400 }
        );
    }
  } catch (error) {
    console.error('‚ùå Banner Display API error:', error);
    return NextResponse.json(
      { success: false, error: 'Internal server error' },
      { status: 500 }
    );
  }
}

// ÏÉàÎ°úÏö¥ ÌÜµÌï© API - Î™®Îì† Íµ¨ Îç∞Ïù¥ÌÑ∞Î•º ÌïúÎ≤àÏóê Í∞ÄÏ†∏Ïò§Í∏∞ (ÏµúÏ†ÅÌôîÎêú Î≤ÑÏ†Ñ)
async function getAllDistrictsData() {
  try {
    console.log(
      'üîç Fetching all districts data for banner display (current table structure)...'
    );

    // ÎèôÏ†ÅÏúºÎ°ú ÌòÑÏû¨ ÎÇ†Ïßú Í∏∞Ï§ÄÏúºÎ°ú ÎåÄÏÉÅ Ïõî Í≥ÑÏÇ∞
    const now = new Date();
    const koreaTime = new Date(now.getTime() + 9 * 60 * 60 * 1000);
    const currentYear = koreaTime.getFullYear();
    const currentMonth = koreaTime.getMonth() + 1;
    const currentDay = koreaTime.getDate();

    // ÌòÑÏû¨ ÎÇ†ÏßúÏóê Îî∞Îùº Ïã†Ï≤≠ Í∞ÄÎä•Ìïú Í∏∞Í∞Ñ Í≥ÑÏÇ∞
    let targetYear = currentYear;
    let targetMonth = currentMonth;

    if (currentDay >= 13) {
      if (currentMonth === 12) {
        targetYear = currentYear + 1;
        targetMonth = 1;
      } else {
        targetMonth = currentMonth + 1;
      }
    }

    const targetYearMonth = `${targetYear}ÎÖÑ ${targetMonth}Ïõî`;
    console.log('üîç Target year/month:', targetYearMonth);

    // 1. region_gu ÌÖåÏù¥Î∏îÏóêÏÑú banner_displayÍ∞Ä ÌôúÏÑ±ÌôîÎêú Íµ¨ Î™©Î°ù Í∞ÄÏ†∏Ïò§Í∏∞
    // region_gu ÌÖåÏù¥Î∏îÏù¥ ÏßÅÏ†ë Íµ¨ Ï†ïÎ≥¥Î•º Í∞ÄÏßÄÍ≥† ÏûàÎäî Íµ¨Ï°∞
    const { data: activeRegions, error: regionError } = await supabase
      .from('region_gu')
      .select('*')
      .eq('display_type_id', '8178084e-1f13-40bc-8b90-7b8ddc58bf64')
      .eq('is_active', 'true');

    if (regionError) {
      console.error('‚ùå Error fetching active regions:', regionError);
      throw regionError;
    }

    // 2. regions Îç∞Ïù¥ÌÑ∞ Î≥ÄÌôò - region_gu ÌÖåÏù¥Î∏îÏù¥ ÏßÅÏ†ë Íµ¨ Ï†ïÎ≥¥Î•º Í∞ÄÏßÄÍ≥† ÏûàÏùå
    const regions = (activeRegions || []).map((region) => ({
      id: region.id,
      name: region.name,
      code: region.code,
      logo_image_url: region.logo_image_url,
      phone_number: region.phone_number,
      display_type_id: region.display_type_id,
      is_active: region.is_active,
    }));

    // 3. Íµ¨Î≥Ñ Ïπ¥Îìú ÏàúÏÑú Î≥ÄÍ≤Ω: Í¥ÄÏïÖÍµ¨, ÎßàÌè¨Íµ¨, ÏÑúÎåÄÎ¨∏Íµ¨, ÏÜ°ÌååÍµ¨, Ïö©ÏÇ∞Íµ¨, Í∞ïÎ∂ÅÍµ¨ ÏàúÏÑúÎ°ú Ï†ïÎ†¨
    const sortedRegions = regions.sort((a, b) => {
      const orderMap: Record<string, number> = {
        Í¥ÄÏïÖÍµ¨: 1,
        ÎßàÌè¨Íµ¨: 2,
        ÏÑúÎåÄÎ¨∏Íµ¨: 3,
        ÏÜ°ÌååÍµ¨: 4,
        Ïö©ÏÇ∞Íµ¨: 5,
        Í∞ïÎ∂ÅÍµ¨: 6,
      };

      const orderA = orderMap[a.name] || 999;
      const orderB = orderMap[b.name] || 999;

      return orderA - orderB;
    });

    console.log('üîç Active regions found:', sortedRegions?.length || 0);

    // 4. Í∞Å ÌôúÏÑ±ÌôîÎêú Íµ¨Î≥ÑÎ°ú Îç∞Ïù¥ÌÑ∞ Ï≤òÎ¶¨
    const processedDistricts = await Promise.all(
      sortedRegions.map(async (region): Promise<ProcessedDistrictData> => {
        // ÏÉàÎ°úÏö¥ Ìå®ÎÑê ÌÉÄÏûÖ Í∏∞Î∞ò Í∞ÄÍ≤© Ï†ïÏ±Ö Ï°∞Ìöå
        const pricePoliciesData = await getPricePoliciesByPanelType(
          region.id,
          region.name
        );

        console.log(`üîç ${region.name} Í∞ÄÍ≤© Ï†ïÏ±Ö Îç∞Ïù¥ÌÑ∞:`, pricePoliciesData);

        // Í∏∞Ï°¥ ÌòïÏãùÏóê ÎßûÍ≤å Î≥ÄÌôò (displayName Ìè¨Ìï®)
        let pricePolicies = pricePoliciesData.map((policy) => ({
          id: policy.id,
          price_usage_type: policy.price_usage_type,
          tax_price: policy.tax_price,
          road_usage_fee: policy.road_usage_fee,
          advertising_fee: policy.advertising_fee,
          total_price: policy.total_price,
          displayName: policy.displayName,
        }));

        console.log(`üîç ${region.name} ÏµúÏ¢Ö Í∞ÄÍ≤© Ï†ïÏ±Ö:`, pricePolicies);

        // Í∏∞Ï°¥ Î∞©ÏãùÎèÑ Î∞±ÏóÖÏúºÎ°ú Ïú†ÏßÄ (Í∞ÄÍ≤©Ï†ïÏ±ÖÏù¥ ÏóÜÏùÑ Í≤ΩÏö∞)
        if (pricePolicies.length === 0) {
          console.log(`üîç ${region.name} Î∞±ÏóÖ Î∞©ÏãùÏúºÎ°ú Ìå®ÎÑê Îç∞Ïù¥ÌÑ∞ Ï°∞Ìöå...`);

          const { data: panelList } = await supabase
            .from('panels')
            .select(
              `id, panel_type, banner_slots (slot_number, banner_slot_price_policy (*))`
            )
            .eq('region_gu_id', region.id)
            .eq('display_type_id', (await getBannerDisplayTypeId()).id)
            .eq('panel_status', 'active')
            .in('panel_type', [
              'panel',
              'with_lighting',
              'no_lighting',
              'multi_panel',
              'lower_panel',
              'semi_auto',
            ])
            .order('id', { ascending: true })
            .limit(20);

          console.log(`üîç ${region.name} Ìå®ÎÑê Î™©Î°ù:`, panelList?.length || 0);

          if (panelList && panelList.length > 0) {
            // slot_number=1Ïù∏ banner_slotsÎßå Ï∂îÏ∂ú
            const slotData = panelList.flatMap((panel: PanelWithSlots) =>
              (panel.banner_slots || []).filter(
                (slot) => slot.slot_number === 1
              )
            );

            console.log(`üîç ${region.name} Ïä¨Î°Ø Îç∞Ïù¥ÌÑ∞:`, slotData.length);

            // Î™®Îì† Ïä¨Î°ØÏùò price_policyÎ•º Ìï©Ï≥êÏÑú uniqueÌïòÍ≤å
            const allPolicies = slotData.flatMap(
              (slot) => slot.banner_slot_price_policy || []
            );

            console.log(
              `üîç ${region.name} Ï†ÑÏ≤¥ Í∞ÄÍ≤© Ï†ïÏ±Ö:`,
              allPolicies.length
            );

            // price_usage_typeÎ≥ÑÎ°ú Ï≤´ Î≤àÏß∏Îßå ÎÇ®Í∏∞Í∏∞
            const uniquePolicies: Record<
              string,
              {
                id: string;
                price_usage_type: string;
                tax_price: number;
                road_usage_fee: number;
                advertising_fee: number;
                total_price: number;
              }
            > = {};

            for (const policy of allPolicies) {
              if (!uniquePolicies[policy.price_usage_type]) {
                uniquePolicies[policy.price_usage_type] = policy;
              }
            }
            pricePolicies = Object.values(uniquePolicies);

            console.log(
              `üîç ${region.name} Î∞±ÏóÖ ÏµúÏ¢Ö Í∞ÄÍ≤© Ï†ïÏ±Ö:`,
              pricePolicies.length,
              pricePolicies
            );
          } else {
            console.log(`üîç ${region.name} Ìå®ÎÑê Îç∞Ïù¥ÌÑ∞ ÏóÜÏùå`);
          }
        }

        // Í∏∞Í∞Ñ Ï†ïÎ≥¥ Í∞ÄÏ†∏Ïò§Í∏∞ - ÏÉàÎ°úÏö¥ region_gu Íµ¨Ï°∞Ïóê ÎßûÍ≤å ÏàòÏ†ï
        const { data: periodDataList, error: periodError } = await supabase
          .from('region_gu_display_periods')
          .select('*')
          .eq('region_gu_id', region.id)
          .eq('display_type_id', (await getBannerDisplayTypeId()).id)
          .eq('year_month', targetYearMonth)
          .order('period_from', { ascending: true });

        let currentPeriodData: {
          first_half_from: string;
          first_half_to: string;
          second_half_from: string | null;
          second_half_to: string | null;
        } | null = null;

        if (periodDataList && periodDataList.length > 0 && !periodError) {
          const periods = periodDataList.map((p: RegionGuDisplayPeriod) => ({
            period_from: p.period_from,
            period_to: p.period_to,
            period: p.period,
            year_month: p.year_month,
          }));

          if (periods.length >= 1) {
            currentPeriodData = {
              first_half_from: periods[0].period_from,
              first_half_to: periods[0].period_to,
              second_half_from:
                periods.length >= 2 ? periods[1].period_from : null,
              second_half_to: periods.length >= 2 ? periods[1].period_to : null,
            };
          }
        }

        // Í≥ÑÏ¢åÎ≤àÌò∏ Ï†ïÎ≥¥ Í∞ÄÏ†∏Ïò§Í∏∞ - region_gu ÌÖåÏù¥Î∏î ÏßÅÏ†ë ÏÇ¨Ïö©
        const { data: bankData } = await supabase
          .from('bank_accounts')
          .select(
            `
            *,
            region_gu!inner(
              id,
              name
            ),
            display_types!inner(
              id,
              name
            )
          `
          )
          .eq('region_gu_id', region.id)
          .eq('display_types.name', 'banner_display')
          .single();

        return {
          id: region.id,
          name: region.name,
          code: region.code,
          logo_image_url: region.logo_image_url,
          phone_number: region.phone_number,
          display_type_id: (await getBannerDisplayTypeId()).id,
          panel_status: 'active',
          period: currentPeriodData,
          bank_accounts: bankData as BankData | null,
          pricePolicies: pricePolicies,
        };
      })
    );

    // 5. Ïπ¥Ïö¥Ìä∏ Ï†ïÎ≥¥ Í∞ÄÏ†∏Ïò§Í∏∞ - aggregate Ìï®Ïàò ÏóêÎü¨ Î∞©ÏßÄ
    const countMap: Record<string, number> = {};
    for (const region of sortedRegions) {
      try {
        const { data: panelData, error: countError } = await supabase
          .from('panels')
          .select('id')
          .eq('region_gu_id', region.id)
          .eq('display_type_id', (await getBannerDisplayTypeId()).id)
          .eq('panel_status', 'active');

        if (countError) {
          console.error(`‚ùå ${region.name} Ïπ¥Ïö¥Ìä∏ Ï°∞Ìöå Ïò§Î•ò:`, countError);
          countMap[region.name] = 0;
        } else {
          countMap[region.name] = panelData?.length || 0;
        }
      } catch (error) {
        console.error(`‚ùå ${region.name} Ïπ¥Ïö¥Ìä∏ Ï°∞Ìöå ÏòàÏô∏:`, error);
        countMap[region.name] = 0;
      }
    }

    console.log('üîç Processed districts data:', processedDistricts.length);
    console.log('üîç Counts data:', countMap);

    return NextResponse.json({
      success: true,
      data: {
        districts: processedDistricts,
        counts: countMap,
      },
    });
  } catch (error) {
    console.error('‚ùå Error in getAllDistrictsData:', error);
    throw error;
  }
}

// ÏÉàÎ°úÏö¥ Í∞ÄÍ≤© Ï†ïÏ±Ö Ï°∞Ìöå Ìï®Ïàò (Ìå®ÎÑê ÌÉÄÏûÖÍ≥º Î∞∞ÎÑà ÌÉÄÏûÖ Í∏∞Î∞ò)
async function getPricePoliciesByPanelType(
  regionId: string,
  regionName: string
) {
  try {
    console.log(`üîç ${regionName} Ìå®ÎÑê ÌÉÄÏûÖÎ≥Ñ Í∞ÄÍ≤© Ï†ïÏ±Ö Ï°∞Ìöå ÏãúÏûë...`);

    // Ìå®ÎÑê ÌÉÄÏûÖÎ≥ÑÎ°ú Í∞ÄÍ≤© Ï†ïÏ±Ö Ï°∞Ìöå
    const { data: panelData, error: panelError } = await supabase
      .from('panels')
      .select(
        `
        id,
        panel_type,
        panel_code,
        banner_slots!inner (
          id,
          slot_number,
          banner_type,
          banner_slot_price_policy!banner_slot_price_policy_banner_slot_id_fkey (
            id,
            price_usage_type,
            total_price,
            tax_price,
            road_usage_fee,
            advertising_fee
          )
        )
      `
      )
      .eq('region_gu_id', regionId)
      .eq('display_type_id', (await getBannerDisplayTypeId()).id)
      .eq('panel_status', 'active')
      .eq('banner_slots.slot_number', 1);

    if (panelError) {
      console.error(`‚ùå ${regionName} Ìå®ÎÑê Îç∞Ïù¥ÌÑ∞ Ï°∞Ìöå Ïò§Î•ò:`, panelError);
      return [];
    }

    console.log(`üîç ${regionName} Ìå®ÎÑê Îç∞Ïù¥ÌÑ∞:`, panelData?.length || 0);

    // Íµ¨Î≥Ñ Î°úÏßÅÏóê Îî∞Îùº Í∞ÄÍ≤© Ï†ïÏ±Ö Ï†ïÎ¶¨
    const pricePolicies: Array<{
      id: string;
      displayName: string;
      price_usage_type: string;
      total_price: number;
      tax_price: number;
      road_usage_fee: number;
      advertising_fee: number;
    }> = [];

    if (panelData && panelData.length > 0) {
      switch (regionName) {
        case 'Í¥ÄÏïÖÍµ¨':
          // Í¥ÄÏïÖÍµ¨: panel_type = panelÏù∏ Í≤ÉÎßå (ÏÉÅÏóÖÏö©, ÏûêÏ≤¥Ï†úÏûë)
          const gwanakPanels = panelData.filter(
            (p) => p.panel_type === 'panel'
          );
          gwanakPanels.forEach((panel) => {
            panel.banner_slots?.forEach((slot) => {
              slot.banner_slot_price_policy?.forEach((policy) => {
                if (policy.price_usage_type === 'default') {
                  pricePolicies.push({
                    ...policy,
                    displayName: 'ÏÉÅÏóÖÏö©',
                  });
                } else if (policy.price_usage_type === 'self_install') {
                  pricePolicies.push({
                    ...policy,
                    displayName: 'ÏûêÏ≤¥Ï†úÏûë',
                  });
                }
              });
            });
          });
          break;

        case 'Ïö©ÏÇ∞Íµ¨':
          // Ïö©ÏÇ∞Íµ¨: panel_type = semi_auto & panel_code = 11,17,19 => ÏÉÅÏóÖÏö©(Ìå®ÎÑêÌòï), ÌñâÏ†ïÏö©
          // ÎÇòÎ®∏ÏßÄÎäî ÏÉÅÏóÖÏö©(ÌòÑÏàòÎßâ), ÌñâÏ†ïÏö©(ÌòÑÏàòÎßâ)
          panelData.forEach((panel) => {
            panel.banner_slots?.forEach((slot) => {
              slot.banner_slot_price_policy?.forEach((policy) => {
                if (
                  panel.panel_type === 'semi_auto' &&
                  [11, 17, 19].includes(panel.panel_code)
                ) {
                  if (policy.price_usage_type === 'default') {
                    pricePolicies.push({
                      ...policy,
                      displayName: 'ÏÉÅÏóÖÏö©(Ìå®ÎÑêÌòï)',
                    });
                  } else if (policy.price_usage_type === 'public_institution') {
                    pricePolicies.push({
                      ...policy,
                      displayName: 'ÌñâÏ†ïÏö©(Ìå®ÎÑêÌòï)',
                    });
                  }
                } else {
                  if (policy.price_usage_type === 'default') {
                    pricePolicies.push({
                      ...policy,
                      displayName: 'ÏÉÅÏóÖÏö©(ÌòÑÏàòÎßâ)',
                    });
                  } else if (policy.price_usage_type === 'public_institution') {
                    pricePolicies.push({
                      ...policy,
                      displayName: 'ÌñâÏ†ïÏö©(ÌòÑÏàòÎßâ)',
                    });
                  }
                }
              });
            });
          });
          break;

        case 'ÎßàÌè¨Íµ¨':
          // ÎßàÌè¨Íµ¨: panel_type = multi_panel ÏÉÅÏóÖÏö©,ÌñâÏ†ïÏö© / panel_type = lower_panel Ï†ÄÎã®ÌòïÏÉÅÏóÖÏö©,Ï†ÄÎã®ÌòïÌñâÏ†ïÏö©
          panelData.forEach((panel) => {
            panel.banner_slots?.forEach((slot) => {
              slot.banner_slot_price_policy?.forEach((policy) => {
                if (panel.panel_type === 'multi_panel') {
                  if (policy.price_usage_type === 'default') {
                    pricePolicies.push({
                      ...policy,
                      displayName: 'ÏÉÅÏóÖÏö©',
                    });
                  } else if (policy.price_usage_type === 'public_institution') {
                    pricePolicies.push({
                      ...policy,
                      displayName: 'ÌñâÏ†ïÏö©',
                    });
                  }
                } else if (panel.panel_type === 'lower_panel') {
                  if (policy.price_usage_type === 'default') {
                    pricePolicies.push({
                      ...policy,
                      displayName: 'Ï†ÄÎã®ÌòïÏÉÅÏóÖÏö©',
                    });
                  } else if (policy.price_usage_type === 'public_institution') {
                    pricePolicies.push({
                      ...policy,
                      displayName: 'Ï†ÄÎã®ÌòïÌñâÏ†ïÏö©',
                    });
                  }
                }
              });
            });
          });
          break;

        case 'ÏÑúÎåÄÎ¨∏Íµ¨':
          // ÏÑúÎåÄÎ¨∏Íµ¨: panel_code = 1-5, panel_type = panel ÌñâÏ†ïÏö©(Ìå®ÎÑêÌòï) / panel_code = 6-16, panel_type = semi_auto ÌñâÏ†ïÏö©(ÌòÑÏàòÎßâ) / panel_code = 1-5,17-24 ÏÉÅÏóÖÏö©
          panelData.forEach((panel) => {
            panel.banner_slots?.forEach((slot) => {
              slot.banner_slot_price_policy?.forEach((policy) => {
                if (
                  [1, 2, 3, 4, 5].includes(panel.panel_code) &&
                  panel.panel_type === 'panel' &&
                  policy.price_usage_type === 'public_institution'
                ) {
                  pricePolicies.push({
                    ...policy,
                    displayName: 'ÌñâÏ†ïÏö©(Ìå®ÎÑêÌòï)',
                  });
                } else if (
                  [6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16].includes(
                    panel.panel_code
                  ) &&
                  panel.panel_type === 'semi_auto' &&
                  policy.price_usage_type === 'public_institution'
                ) {
                  pricePolicies.push({
                    ...policy,
                    displayName: 'ÌñâÏ†ïÏö©(ÌòÑÏàòÎßâ)',
                  });
                } else if (
                  [1, 2, 3, 4, 5, 17, 18, 19, 20, 21, 22, 23, 24].includes(
                    panel.panel_code
                  ) &&
                  policy.price_usage_type === 'default'
                ) {
                  pricePolicies.push({
                    ...policy,
                    displayName: 'ÏÉÅÏóÖÏö©',
                  });
                }
              });
            });
          });
          break;

        case 'ÏÜ°ÌååÍµ¨':
          // ÏÜ°ÌååÍµ¨: panel_type = panel ÏÉÅÏóÖÏö©, ÌñâÏ†ïÏö©
          const songpaPanels = panelData.filter(
            (p) => p.panel_type === 'panel'
          );
          songpaPanels.forEach((panel) => {
            panel.banner_slots?.forEach((slot) => {
              slot.banner_slot_price_policy?.forEach((policy) => {
                if (policy.price_usage_type === 'default') {
                  pricePolicies.push({
                    ...policy,
                    displayName: 'ÏÉÅÏóÖÏö©',
                  });
                } else if (policy.price_usage_type === 'public_institution') {
                  pricePolicies.push({
                    ...policy,
                    displayName: 'ÌñâÏ†ïÏö©',
                  });
                }
              });
            });
          });
          break;

        default:
          // Í∏∞Î≥∏: Î™®Îì† Í∞ÄÍ≤© Ï†ïÏ±Ö ÌëúÏãú
          panelData.forEach((panel) => {
            panel.banner_slots?.forEach((slot) => {
              slot.banner_slot_price_policy?.forEach((policy) => {
                pricePolicies.push({
                  ...policy,
                  displayName: getUsageDisplayName(policy.price_usage_type),
                });
              });
            });
          });
      }
    }

    // Ï§ëÎ≥µ Ï†úÍ±∞ (Í∞ôÏùÄ displayNameÍ≥º total_priceÎ•º Í∞ÄÏßÑ Ï†ïÏ±ÖÏùÄ ÌïòÎÇòÎßå)
    const uniquePolicies = pricePolicies.filter(
      (policy, index, self) =>
        index ===
        self.findIndex(
          (p) =>
            p.displayName === policy.displayName &&
            p.total_price === policy.total_price
        )
    );

    console.log(`üîç ${regionName} ÏµúÏ¢Ö Í∞ÄÍ≤© Ï†ïÏ±Ö:`, uniquePolicies);
    return uniquePolicies;
  } catch (error) {
    console.error(`‚ùå ${regionName} Í∞ÄÍ≤© Ï†ïÏ±Ö Ï°∞Ìöå Ïò§Î•ò:`, error);
    return [];
  }
}

// Ïö©ÎèÑÎ≥Ñ ÌëúÏãúÎ™Ö Îß§Ìïë Ìï®Ïàò
function getUsageDisplayName(usageType: string): string {
  switch (usageType) {
    case 'default':
      return 'ÏÉÅÏóÖÏö©';
    case 'public_institution':
      return 'ÌñâÏ†ïÏö©';
    case 're_order':
      return 'Ïû¨ÏÇ¨Ïö©';
    case 'self_install':
      return 'ÏûêÏ≤¥Ï†úÏûë';
    case 'reduction_by_admin':
      return 'Í¥ÄÎ¶¨ÏûêÌï†Ïù∏';
    case 'rent_place':
      return 'ÏûêÎ¶¨ÎåÄÏó¨';
    default:
      return usageType;
  }
}

// ÏµúÏ†ÅÌôîÎêú Íµ¨Î≥Ñ Îç∞Ïù¥ÌÑ∞ Ï°∞Ìöå (DB View ÏÇ¨Ïö©)
async function getOptimizedDistrictsData() {
  try {
    console.log('üîç Fetching optimized districts data using DB view...');

    // DB ViewÏóêÏÑú Ìïú Î≤àÏóê Î™®Îì† Îç∞Ïù¥ÌÑ∞ Í∞ÄÏ†∏Ïò§Í∏∞
    const { data: viewData, error: viewError } = await supabase
      .from('banner_display_summary')
      .select('*');

    if (viewError) {
      console.error('‚ùå DB View Ï°∞Ìöå Ïò§Î•ò:', viewError);
      throw viewError;
    }

    console.log('üîç DB View Îç∞Ïù¥ÌÑ∞:', viewData?.length || 0);

    // Î∑∞ Îç∞Ïù¥ÌÑ∞Î•º ÌîÑÎ°†Ìä∏ÏóîÎìú ÌòïÏãùÏúºÎ°ú Î≥ÄÌôò
    const processedDistricts = (viewData || []).map((item) => {
      // Í∞ÄÍ≤© Ï†ïÏ±Ö ÌååÏã±
      const pricePolicies = item.price_summary
        ? item.price_summary.split(', ').map((priceStr) => {
            const [displayName, totalPrice] = priceStr.split(':');
            return {
              id: `temp_${displayName}`,
              price_usage_type: 'default', // ÏûÑÏãúÍ∞í
              tax_price: 0,
              road_usage_fee: 0,
              advertising_fee: 0,
              total_price: parseInt(totalPrice) || 0,
              displayName: displayName.trim(),
            };
          })
        : [];

      // Í∏∞Í∞Ñ Ï†ïÎ≥¥ ÌååÏã±
      let periodData = null;
      if (item.period_summary) {
        const periods = item.period_summary.split(', ');
        if (periods.length >= 1) {
          const [firstFrom, firstTo] = periods[0].split('~');
          periodData = {
            first_half_from: firstFrom,
            first_half_to: firstTo,
            second_half_from:
              periods.length >= 2 ? periods[1].split('~')[0] : null,
            second_half_to:
              periods.length >= 2 ? periods[1].split('~')[1] : null,
          };
        }
      }

      // ÏùÄÌñâ Ï†ïÎ≥¥
      const bankData = item.bank_name
        ? {
            id: `temp_bank_${item.region_id}`,
            bank_name: item.bank_name,
            account_number: item.account_number,
            depositor: item.depositor,
            region_gu: {
              id: item.region_id,
              name: item.region_name,
            },
            display_types: {
              id: '8178084e-1f13-40bc-8b90-7b8ddc58bf64',
              name: 'banner_display',
            },
          }
        : null;

      return {
        id: item.region_id,
        name: item.region_name,
        code: item.region_code,
        logo_image_url: item.logo_image_url,
        phone_number: item.phone_number,
        display_type_id: '8178084e-1f13-40bc-8b90-7b8ddc58bf64',
        panel_status: 'active',
        period: periodData,
        bank_accounts: bankData,
        pricePolicies: pricePolicies,
      };
    });

    // Ïπ¥Ïö¥Ìä∏ Ï†ïÎ≥¥ (Ïù¥ÎØ∏ Î∑∞Ïóê Ìè¨Ìï®Îê®)
    const countMap: Record<string, number> = {};
    processedDistricts.forEach((district) => {
      countMap[district.name] = parseInt(
        district.panel_count?.toString() || '0'
      );
    });

    console.log('üîç Optimized districts data:', processedDistricts.length);
    console.log('üîç Counts data:', countMap);

    return NextResponse.json({
      success: true,
      data: {
        districts: processedDistricts,
        counts: countMap,
      },
    });
  } catch (error) {
    console.error('‚ùå Error in getOptimizedDistrictsData:', error);
    throw error;
  }
}
